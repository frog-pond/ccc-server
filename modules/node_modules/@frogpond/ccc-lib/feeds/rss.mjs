import {get} from '@frogpond/ccc-lib'
import _jsdom from 'jsdom'
const {JSDOM} = _jsdom

export async function fetchRssFeed(url, query = {}) {
	const resp = await get(url, {query})
	let dom = new JSDOM(resp.body, {contentType: 'text/xml'})

	let storyEls = [...dom.window.document.querySelectorAll('item')]
	return storyEls.map(convertRssItemToStory)
}

export function convertRssItemToStory(item) {
	const authors = item.getAttribute('dc:creator') || ['Unknown Author']
	const categories = [...item.querySelectorAll('category')] || []

	const link = item.querySelector('link')
		? item.querySelector('link').textContent
		: null

	let title = item.querySelector('title')
	title = title ? title.textContent : '(no title)'
	title = JSDOM.fragment(title).textContent.trim()

	let datePublished = item.querySelector('pubDate')
	datePublished = datePublished ? datePublished.textContent : null

	let descriptionEl = item.querySelector('description')

	let content = item.getAttribute('content:encoded')
	content = content || (descriptionEl && descriptionEl.textContent)
	content = content || '(no content)'
	content = JSDOM.fragment(content).textContent.trim()

	let excerpt = descriptionEl
		? descriptionEl.textContent
		: content.substr(0, 250)
	excerpt = JSDOM.fragment(excerpt).textContent.trim()

	return {
		authors,
		categories,
		content,
		datePublished,
		excerpt,
		featuredImage: null,
		link,
		title,
	}
}
